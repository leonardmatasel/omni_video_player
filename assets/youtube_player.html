<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }

        .embed-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: black;
            transition: background-color 0.2s ease;
        }

        .embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            transition: opacity 0.18s ease, visibility 0.18s ease;
        }

        .embed-container iframe.hidden-player {
            visibility: hidden;
            opacity: 0;
        }
    </style>
    <title>Youtube Player</title>
</head>
<body>
<div class="embed-container">
    <div id="<<playerId>>"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    var player;
    var progressTimer = null;
    var isHidden = false; // variabile di stato

    function onYouTubeIframeAPIReady() {
        player = new YT.Player("<<playerId>>", {
            host: "https://www.youtube-nocookie.com",
            playerVars: <<playerVars>>,
            events: {
                onReady: function(e) { handleFullScreenForMobilePlatform(); sendMessage("Ready", e); },
                onStateChange: onPlayerStateChange,
                onError: function(e){ sendMessage("PlayerError", e.data); }
            }
        });
        player.setSize(window.innerWidth, window.innerHeight);
    }

    // Funzione unica per mostrare/nascondere
    function setIframeHidden(hidden) {
        if(isHidden === hidden) return; // giÃ  nello stato giusto
        isHidden = hidden;
        const iframe = player.getIframe();
        if(hidden) iframe.classList.add("hidden-player");
        else iframe.classList.remove("hidden-player");
    }

    function onPlayerStateChange(e) {
        sendMessage("StateChange", e.data);
        clearInterval(progressTimer);

        if(e.data === YT.PlayerState.PLAYING) {
            setIframeHidden(false); // mostra iframe
            progressTimer = setInterval(()=>{
                try {
                    const state = { currentTime: player.getCurrentTime(), loadedFraction: player.getVideoLoadedFraction() };
                    sendMessage("PlaybackProgress", JSON.stringify(state));
                } catch(e){}
            }, 800);
        }
    }

    // override play
    async function play() {
        setIframeHidden(true);
        await sleep(300);
        try { player.playVideo(); } catch(e){}
        return '';
    }

    // override seekTo
    async function seekTo(pos, seekAhead) {
        setIframeHidden(true);
        await sleep(300);
        try{ player.seekTo(Number(pos)||0, seekAhead); } catch(e){}
        return '';
    }

    // override loadById
    async function loadById(settings) {
        setIframeHidden(true);
        await sleep(300);
        try{ player.loadVideoById(settings); } catch(e){}
        try{ player.playVideo(); } catch(e){}
        return '';
    }

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    window.onresize = function(){ try{ player.setSize(window.innerWidth, window.innerHeight); } catch(e){} };
    function sendMessage(key,data){
        var msg={};
        msg[key]=data;
        msg['playerId']='<<playerId>>';
        try{ window.flutter_inappwebview.callHandler(key,data); }
        catch(e){ try{ window.parent.postMessage(JSON.stringify(msg),'*'); } catch(e){} }
    }
    function handleFullScreenForMobilePlatform(){}
</script>
</body>
</html>
