<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }

        .embed-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: black;
            transition: background-color 0.2s ease;
        }

        .embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            transition: opacity 0.18s ease, visibility 0.18s ease;
        }

        .embed-container iframe.hidden-player {
            visibility: hidden;
            opacity: 0;
        }

        .embed-container iframe.hidden-player + * {
            background: black;
        }
    </style>
    <title>Youtube Player</title>
</head>
<body>
<div class="embed-container">
    <div id="<<playerId>>"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    var player;
    var progressTimer = null;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("<<playerId>>", {
        host: "https://www.youtube-nocookie.com",
        playerVars: <<playerVars>>,
        events: {
          onReady: function(e) { handleFullScreenForMobilePlatform(); sendMessage("Ready", e); },
          onStateChange: function(e) {
            sendMessage("StateChange", e.data);
            clearInterval(progressTimer);
            if (e.data === YT.PlayerState.PLAYING) {
            const iframe = player.getIframe();
            iframe.classList.remove("hidden-player");
              progressTimer = setInterval(()=>{
                try {
                  const state = { currentTime: player.getCurrentTime(), loadedFraction: player.getVideoLoadedFraction() };
                  sendMessage("PlaybackProgress", JSON.stringify(state));
                } catch(e){}
              }, 800);
            }
          },
          onError: function(e){ sendMessage("PlayerError", e.data); }
        }
      });
      player.setSize(window.innerWidth, window.innerHeight);
    }

    // override play
    async function play() {
      const iframe = player.getIframe();
      iframe.classList.add("hidden-player");
      await sleep(300);
      let now = 0;
      try { now = player.getCurrentTime(); } catch(e){ now = 0; }
      try{ player.playVideo(); } catch(e){}
      return '';
    }

    // override seekTo
    async function seekTo(pos, seekAhead) {
      const iframe = player.getIframe();
      iframe.classList.add("hidden-player");
      await sleep(300);
      let start = Number(pos)||0;
      try{ player.seekTo(pos, seekAhead); } catch(e){}
      return '';
    }

    // override loadById
    async function loadById(settings) {
      const iframe = player.getIframe();
      iframe.classList.add("hidden-player");
      await sleep(300);
      let start = 0;
      if(settings && typeof settings.startSeconds !== "undefined") start = Number(settings.startSeconds)||0;
      try{ player.loadVideoById(settings); } catch(e){}
      try{ player.playVideo(); } catch(e){}
      return '';
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    window.onresize = function(){ try{ player.setSize(window.innerWidth, window.innerHeight); } catch(e){} };
    function sendMessage(key,data){ var msg={}; msg[key]=data; msg['playerId']='<<playerId>>'; try{ window.flutter_inappwebview.callHandler(key,data); } catch(e){ try{ window.parent.postMessage(JSON.stringify(msg),'*'); } catch(e){} } }
    function handleFullScreenForMobilePlatform(){}
</script>
</body>
</html>
